name: publish_conda

on:
  release:
    types: [published]
    
jobs:
  publish:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set Environment Variables
      run: |
        sed "/#/d" ./.github/variables/anaconda_variables.env >> "$GITHUB_ENV"
        echo "" >>  "$GITHUB_ENV"
        echo "RELEASE_VERSION=$(awk -F'\"' '/__version__/ {print $2}' commlib/__init__.py)" >> "$GITHUB_ENV"
        echo "CONDA=$CONDA" >> "$GITHUB_ENV"
      shell: bash

    - name: Update conda environment
      run: |
        source ${{ env.CONDA }}/etc/profile.d/conda.sh
        conda update -n base -c defaults conda
        conda create -n ANACONDA
        conda activate ANACONDA
        conda info | grep "user-agent"

    - name: Install Anaconda Client & Conda build - Activate base!
      run: |
        source ${{ env.CONDA }}/etc/profile.d/conda.sh
        conda activate ANACONDA
        conda install -y anaconda-client conda-build

    - name: Build conda package
      run: |
        source ${{ env.CONDA }}/etc/profile.d/conda.sh
        conda activate ANACONDA
        conda-build -c conda-forge --output-folder ${{ env.CONDA_BUILD_DIR }} .conda
    
    - name: Upload package
      run: |
        source ${{ env.CONDA }}/etc/profile.d/conda.sh
        conda activate ANACONDA
        find ${{ env.CONDA_BUILD_DIR }} -name *.tar.bz2 | while read file
        do
            anaconda -t ${{ secrets.ANACONDA_TOKEN }} upload -u ${{ env.ANACONDA_CHANNEL }} $file
        done
    
    - name: Cleanup
      run: |
        rm -rf ${{ env.CONDA_BUILD_DIR }}
